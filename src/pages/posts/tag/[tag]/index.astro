---
import Layout from "@/layouts/Layout.astro";
import DefaultMetadata from "@/utils/DefaultMetadata";
import type { MarkdownInstance } from "astro";
import Header from "@/components/header/Header.astro";
import Footer from "@/components/footer/Footer.astro";
import type Frontmatter from "@/types/Frontmatter";
import type Metadata from "@/types/Metadata";
import Main from "@/components/posts/main/Main.astro";

export async function getStaticPaths() {
  const posts: MarkdownInstance<Frontmatter>[] = await Astro.glob<Frontmatter>(
    "../../../../../posts/*.md",
  );

  const activePosts = posts.filter((post) => post.frontmatter.isActive);

  const tags: string[] = [];
  activePosts.forEach((post) => {
    post.frontmatter.tags.forEach((tag) => {
      if (!tags.includes(tag)) {
        tags.push(tag);
      }
    });
  });

  return tags.map((tag) => ({
    params: {
      tag: tag,
    },
    props: {
      posts: activePosts.filter((post) => post.frontmatter.tags.includes(tag)),
      tag: tag,
    },
  }));
}

const { posts, tag }: { posts: MarkdownInstance<Frontmatter>[]; tag: string } = Astro.props;

const frontmatters: Frontmatter[] = posts.map((post) => post.frontmatter);

const metaData: Metadata = {
  ...DefaultMetadata,
  title: `kanakanho's blog Posts tag ${tag}`,
  openGraph: {
    ...DefaultMetadata.openGraph,
    title: `kanakanho's blog Posts tag ${tag}`,
    url: `${DefaultMetadata.openGraph?.url}/posts/${tag}`,
  },
};
---

<Layout metadata={metaData}>
  <Header navigate="posts" />
  <Main frontmatters={frontmatters} tag={tag} />
  <Footer />
</Layout>
