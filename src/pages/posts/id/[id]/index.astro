---
import Layout from "@/layouts/Layout.astro";
import DefaultMetadata from "@/utils/DefaultMetadata";
import type { MarkdownInstance } from "astro";
import { GetImageType } from "@/utils/GetImageType";
import Header from "@/components/header/Header.astro";
import Footer from "@/components/footer/Footer.astro";
import Article from "@/components/posts/article/Article.astro";
import type Frontmatter from "@/types/Frontmatter";
import type Metadata from "@/types/Metadata";

export async function getStaticPaths() {
  const posts: MarkdownInstance<Frontmatter>[] = await Astro.glob<Frontmatter>(
    "../../../../../posts/*.md",
  );

  return posts
    .filter((post) => post.frontmatter.isActive)
    .map((post) => ({
      params: {
        id: post.frontmatter.number.toString(),
      },
      props: {
        post: {
          frontmatter: post.frontmatter,
          Content: post.Content,
        },
      },
    }));
}

const frontmatter = Astro.props.post.frontmatter;
const [extension, imageTypeError] = GetImageType(
  frontmatter.options?.image?.split(".").pop() as string,
);

const metaData: Metadata = {
  ...DefaultMetadata,
  title: frontmatter.title,
  description:
    `${frontmatter.options?.description} -${DefaultMetadata.title}` || DefaultMetadata.description,
  openGraph: {
    ...DefaultMetadata.openGraph,
    title: frontmatter.title,
    description:
      `${frontmatter.options?.description} -${DefaultMetadata.title}` ||
      DefaultMetadata.openGraph?.description,
    url: `${DefaultMetadata.openGraph?.url}/posts/id/${Astro.props.post.frontmatter.title}`,
    image: frontmatter.options?.image || DefaultMetadata.openGraph?.image,
    imageAlt: `記事【${frontmatter.title}】のタイトル画像`,
  },
  twitter: {
    ...DefaultMetadata.twitter,
    description:
      `${frontmatter.options?.description}  -${DefaultMetadata.title}` ||
      DefaultMetadata.twitter?.description,
    image: !imageTypeError ? frontmatter.options?.image : DefaultMetadata.twitter?.image,
    imageType: !imageTypeError
      ? extension
        ? extension
        : DefaultMetadata.twitter?.imageType
      : DefaultMetadata.twitter?.imageType,
  },
};

const { Content } = Astro.props.post;
---

<Layout metadata={metaData}>
  <Header navigate="posts" />
  <Article
    Content={Content}
    title={frontmatter.title}
    tags={frontmatter.tags}
    repoUrl={frontmatter.options?.repository}
    youtubeUrl={frontmatter.options?.youtube}
    websiteUrl={frontmatter.options?.website}
    date={Astro.props.post.frontmatter.date}
  />
  <Footer />
</Layout>
